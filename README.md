# B站自动最高画质脚本

🚀 一款轻量级 Tampermonkey 脚本，自动选择 B 站视频/直播的最高可用分辨率

## ✨ 功能特性

### 🎥 视频页面
- **自动选择最高画质** - 页面加载时自动切换到最高可用分辨率
- **智能VIP检测** - 自动识别用户VIP状态，跳过VIP限制的选项
- **高音质支持** - 可选自动启用杜比视界、Hi-Res等高级音质
- **支持所有视频类型** - 普通视频、番剧、电影等

### 🔴 直播页面
- **直播画质自动切换** - 实时直播自动选择最高画质
- **API级别控制** - 使用播放器API直接切换，无延迟

### ⚙️ 通用功能
- **智能重试机制** - 指数退避算法，确保选择成功
- **SPA路由支持** - 自动监听页面切换，重新初始化选择
- **操作提示通知** - 浮窗显示画质切换结果
- **开发者接口** - 暴露控制接口供开发者使用
- **无日志污染** - 仅在调试模式下输出日志

## 📦 支持的分辨率

### 视频页面
| 代码 | 分辨率 | 需求 |
|-----|--------|------|
| 16 | 360P | 无 |
| 32 | 480P | 无 |
| 64 | 720P | 无（Web默认） |
| 74 | 720P60 | 登录 |
| 80 | 1080P | 登录 |
| 112 | 1080P+ | VIP |
| 116 | 1080P60 | VIP |
| 120 | 4K | VIP |
| 125 | HDR | VIP |
| 126 | 杜比视界 | VIP |
| 127 | 8K | VIP |

### 直播页面
| 代码 | 画质 |
|-----|------|
| 80 | 流畅 |
| 150 | 高清 |
| 250 | 超清 |
| 400 | 蓝光 |
| 10000 | 原画 |
| 20000 | 4K |
| 30000 | 杜比 |

## 🚀 快速开始

### 安装方式

#### 方式一：GreasyFork（推荐）
访问 GreasyFork 页面并点击安装：
[B站自动最高画质 - GreasyFork](https://greasyfork.org/en/scripts/...)

#### 方式二：手动安装
1. 安装 [Tampermonkey](https://tampermonkey.net/) 浏览器扩展
2. 创建新脚本，复制 `bilibili-auto-quality.user.js` 的内容
3. 保存并启用脚本

## 🎯 使用说明

### 自动工作
脚本在以下情况下自动工作：
- ✅ B站视频页面加载
- ✅ B站直播页面加载
- ✅ 番剧页面加载
- ✅ 切换到新视频（SPA路由）

### 开发者接口

在浏览器控制台使用：

```javascript
// 查看配置
console.log(BilibiliAutoQuality.CONFIG);

// 手动选择视频最高画质
BilibiliAutoQuality.selectVideo();

// 手动选择直播最高画质
BilibiliAutoQuality.selectLive();

// 启用/禁用脚本
BilibiliAutoQuality.setEnabled(true);  // 启用
BilibiliAutoQuality.setEnabled(false); // 禁用

// 启用调试模式（查看详细日志）
BilibiliAutoQuality.setDebug(true);
```

## ⚙️ 配置选项

脚本使用 `GM_setValue` 存储配置，支持以下选项：

```javascript
{
  enabled: true,              // 脚本总开关
  autoSelectAudio: true,      // 自动选择最高音质
  showNotification: true,     // 显示操作提示
  debug: false,               // 调试模式
}
```

## 🔍 工作原理

### 1️⃣ 页面检测
- 识别当前页面类型（视频/直播/番剧）
- 确定使用的控制方式

### 2️⃣ 画质获取
**视频页面**：
- 遍历DOM中的画质菜单项
- 跳过VIP限制项（非VIP用户）
- 选择第一个可用项（最高画质）

**直播页面**：
- 调用播放器API获取可用画质列表
- 计算最高QN值
- 通过API切换

### 3️⃣ 重试机制
- 使用指数退避算法（200ms → 300ms → 450ms → ...）
- 最多重试15次
- 确保在播放器延迟加载时仍能成功选择

### 4️⃣ 导航监听
- 监听URL变化（普通导航和SPA路由）
- 自动在新页面重新初始化选择

## 🐛 常见问题

### Q: 为什么有时候不能切换到最高画质？
A: 几个可能的原因：
1. **未登录** - 1080P 及以上需要登录
2. **非VIP用户** - 1080P+、4K、8K 等需要VIP
3. **播放器未加载** - 脚本会自动重试，通常几秒内会切换成功
4. **浏览器限制** - 某些浏览器或配置可能限制最高分辨率

### Q: 可以禁用脚本吗？
A: 可以！两种方式：
1. **通过Tampermonkey** - 禁用脚本
2. **通过控制台** - `BilibiliAutoQuality.setEnabled(false)`

### Q: 脚本会影响性能吗？
A: 不会。脚本非常轻量级：
- ✅ 仅在初始化时运行，之后无持续操作
- ✅ 不监听页面元素变化（除了路由变化）
- ✅ 没有网络请求
- ✅ 总代码大小 < 8KB

### Q: 直播没有自动切换？
A: 直播的API加载时间较长，脚本会自动重试。如果仍未成功：
1. 在控制台运行 `BilibiliAutoQuality.selectLive()`
2. 启用调试模式查看日志：`BilibiliAutoQuality.setDebug(true)`

## 📊 版本历史

### v1.0.0 (2025-10-22)
- ✨ 初始版本
- 🎥 支持视频页面自动最高画质
- 🔴 支持直播页面自动最高画质
- 📋 支持番剧页面
- 🎵 可选高音质自动选择
- 📢 操作结果通知
- 🔧 开发者接口

## 🔒 隐私与安全

- ✅ **完全离线** - 无服务器调用，无数据收集
- ✅ **无权限滥用** - 仅读取页面信息，不修改网页内容
- ✅ **开源透明** - 所有代码公开，可审计
- ✅ **不依赖第三方** - 仅使用浏览器原生API

## 🤝 贡献与反馈

欢迎提交Issue和Pull Request！

## 📝 许可证

MIT License - 详见 LICENSE 文件

---

**祝您观看愉快！🎬**

让B站自动为您调到最高画质～
